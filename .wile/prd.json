{
  "userStories": [
    {
      "id": "US-001",
      "title": "Initialize monorepo structure",
      "acceptanceCriteria": [
        "Create packages/cli/ and packages/agent/ directories",
        "Root package.json with workspaces configured for bun",
        "packages/agent/package.json with basic metadata",
        "packages/cli/package.json with bin field pointing to dist/cli.js",
        ".gitignore with node_modules, dist, .env files"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Using bun workspaces"
    },
    {
      "id": "US-002",
      "title": "Create Dockerfile base",
      "acceptanceCriteria": [
        "packages/agent/Dockerfile exists",
        "Based on Ubuntu 22.04 LTS",
        "Installs: git, curl, bun, Node.js 20 LTS",
        "Installs: Python 3.11 with pip",
        "Sets up non-root user 'wile'",
        "Configures swap (8GB), zswap with lz4, earlyoom",
        "Sets vm.swappiness=10",
        "Sets NODE_OPTIONS=--max-old-space-size=4096"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Memory config per Claude Code specs"
    },
    {
      "id": "US-003",
      "title": "Install Claude Code in Docker",
      "acceptanceCriteria": [
        "Claude Code CLI installed via npm globally",
        "Verify claude --version runs successfully",
        "CC_ANTHROPIC_API_KEY can be passed as env var"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Package is @anthropic-ai/claude-code"
    },
    {
      "id": "US-004",
      "title": "Install Playwright in Docker",
      "acceptanceCriteria": [
        "Playwright installed with Chromium browser",
        "npx playwright test --version runs successfully",
        "Headless browser can screenshot a webpage",
        "Create packages/agent/scripts/browser-test.ts helper"
      ],
      "priority": 4,
      "passes": true,
      "notes": "For visual verification of UI changes"
    },
    {
      "id": "US-005",
      "title": "Create wile.sh main loop script",
      "acceptanceCriteria": [
        "packages/agent/scripts/wile.sh exists",
        "Accepts MAX_ITERATIONS as argument (default 25)",
        "Reads prompt from packages/agent/scripts/prompt.md",
        "Pipes prompt to claude --dangerously-skip-permissions",
        "Captures output and checks for <promise>COMPLETE</promise>",
        "Loops until complete or max iterations",
        "Exits with appropriate codes (0=success, 1=max iterations)"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Core loop logic from Ralph"
    },
    {
      "id": "US-006",
      "title": "Create prompt.md agent instructions",
      "acceptanceCriteria": [
        "packages/agent/scripts/prompt.md exists",
        "Instructions to read .wile/prd.json from repo root",
        "Instructions to read .wile-temp/progress.txt",
        "Instructions to pick highest priority story where passes=false",
        "Instructions to implement ONE story per iteration",
        "Instructions to run tests and typecheck",
        "Instructions to commit with format: feat: [ID] - [Title]",
        "Instructions to push after each commit",
        "Instructions to update .wile/prd.json passes=true",
        "Instructions to append learnings to progress.txt",
        "Stop condition: reply <promise>COMPLETE</promise> when all pass"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Agent brain - critical for success"
    },
    {
      "id": "US-007",
      "title": "Create entrypoint.sh",
      "acceptanceCriteria": [
        "packages/agent/entrypoint.sh exists",
        "Clones repo from GITHUB_REPO_URL env var",
        "Checks out BRANCH_NAME env var",
        "Creates .wile-temp/ directory",
        "Nukes .wile-temp/ if it exists",
        "Adds .wile-temp/ to .gitignore if not present",
        "Creates initial .wile-temp/progress.txt",
        "Commits gitignore changes",
        "Pushes initial commit",
        "Runs wile.sh with MAX_ITERATIONS",
        "On completion: ensures final state is pushed",
        "On partial completion: commits WIP with explanation",
        "On no changes: creates .wile-temp/failed-{timestamp}.txt"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Container startup orchestration"
    },
    {
      "id": "US-008",
      "title": "Configure git in Docker",
      "acceptanceCriteria": [
        "Git configured with wile bot identity",
        "user.name = 'Wile Bot'",
        "user.email = 'wile@bot.local'",
        "GitHub token auth works via GITHUB_TOKEN env var",
        "Can clone, commit, push to private repos"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Configured in entrypoint.sh with credential helper"
    },
    {
      "id": "US-009",
      "title": "Create docker-compose for local testing",
      "acceptanceCriteria": [
        "packages/agent/docker-compose.yml exists",
        "Mounts local .env file for secrets",
        "Environment variables documented in .env.example",
        "Can build and run with: docker compose up --build",
        "Includes volume mount for testing with local repos"
      ],
      "priority": 9,
      "passes": true,
      "notes": "For local development and testing"
    },
    {
      "id": "US-010",
      "title": "Add browser testing to prompt.md",
      "acceptanceCriteria": [
        "prompt.md includes instructions for browser verification",
        "When acceptance criteria mention UI/visual checks",
        "Agent should use Playwright to screenshot",
        "Screenshots saved to .wile-temp/screenshots/",
        "Include browser-test.ts usage examples in prompt"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Visual verification capability"
    },
    {
      "id": "US-011",
      "title": "Create .env.example and documentation",
      "acceptanceCriteria": [
        "packages/agent/.env.example with all required vars",
        "CC_ANTHROPIC_API_KEY documented",
        "GITHUB_TOKEN documented",
        "GITHUB_REPO_URL documented",
        "BRANCH_NAME documented",
        "MAX_ITERATIONS documented (default 25)",
        "Project env vars are forwarded from .env.project",
        "packages/agent/README.md with usage instructions"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Documentation for local testing"
    },
    {
      "id": "US-012",
      "title": "Test full Docker flow locally",
      "acceptanceCriteria": [
        "Can run docker compose up --build successfully",
        "Container clones a test repo",
        "Container creates branch and .wile-temp/",
        "Container runs at least one iteration",
        "Container commits and pushes changes",
        "Logs are visible and informative"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Integration test before moving to CLI/EC2; STOP HERE FOR HUMAN APPROVAL."
    },
    {
      "id": "US-101",
      "title": "Initialize CLI package with Bun",
      "acceptanceCriteria": [
        "packages/cli/package.json configured properly",
        "bin field points to dist/cli.js",
        "name is 'wile'",
        "TypeScript configured with tsconfig.json",
        "Entry point src/cli.ts with shebang #!/usr/bin/env node"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-102",
      "title": "Install CLI dependencies",
      "acceptanceCriteria": [
        "commander installed for argument parsing",
        "dotenv installed for env file handling",
        "prompts installed for testable TUI"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-103",
      "title": "Create CLI entry point with commander",
      "acceptanceCriteria": [
        "src/cli.ts parses commands: config, run",
        "wile config triggers config flow",
        "wile run triggers run flow",
        "wile run --repo=X works for non-local",
        "Help text is clear and useful",
        "Version flag works"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-104",
      "title": "Implement 'wile config' command",
      "acceptanceCriteria": [
        "Uses prompts for interactive prompts and inject-based testing",
        "Prompts for GitHub token (password input)",
        "Prompts for GitHub repo URL",
        "Prompts for default branch name",
        "Prompts for coding agent (default CC) and writes CODING_AGENT=CC",
        "Radio prompt for Claude Code auth: OAuth token vs API key",
        "Shows a tip describing how to obtain the selected auth",
        "When Claude Code is chosen, prompts for default model: sonnet or opus",
        "Writes .wile/secrets/.env in the current project",
        "Required keys in .wile/secrets/.env: CODING_AGENT, WILE_REPO_SOURCE, BRANCH_NAME (github only), GITHUB_TOKEN (github only), GITHUB_REPO_URL (github only), and one of CC_CLAUDE_CODE_OAUTH_TOKEN or CC_ANTHROPIC_API_KEY",
        "Writes CC_CLAUDE_MODEL in .wile/secrets/.env when Claude Code is selected",
        "Creates .wile/secrets/.env.project with a comment explaining it is forwarded into the container",
        "Creates .wile/.gitignore that ignores secrets/ and screenshots/",
        "Creates .wile/prd.json if missing with an empty userStories array",
        "Creates .wile/prd.json.example with the first 6 stories from the test-tictactoe example",
        "Creates .wile/additional-instructions.md if missing for optional extra agent guidance",
        "Re-running config allows pressing enter to keep existing values",
        "Shows a success message and tells the user to add project env vars to .wile/secrets/.env.project"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-105",
      "title": "Implement .env.project handling in config",
      "acceptanceCriteria": [
        "After config, creates .wile/secrets/.env.project",
        "Includes a comment explaining env vars in this file are forwarded into the container",
        "File is created if missing and preserved on rerun"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-106",
      "title": "Create config reading utilities",
      "acceptanceCriteria": [
        "src/lib/config.ts exists",
        "Reads .wile/secrets/.env",
        "Reads .wile/secrets/.env.project",
        "Validates required keys are present",
        "Required keys: CODING_AGENT=CC, WILE_REPO_SOURCE, BRANCH_NAME (github only), GITHUB_TOKEN (github only), GITHUB_REPO_URL (github only), and one of CC_CLAUDE_CODE_OAUTH_TOKEN or CC_ANTHROPIC_API_KEY",
        "Returns typed config object",
        "Helpful error messages if config missing"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-107",
      "title": "Align setup iteration 0 with new config flow",
      "acceptanceCriteria": [
        "packages/agent/scripts/prompt-setup.md does not modify .gitignore",
        "Setup iteration performs no side effects",
        "No console output beyond required error reporting"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-108",
      "title": "Implement 'wile run' command",
      "acceptanceCriteria": [
        "Reads config from .wile/secrets",
        "Validates .wile is configured: .wile/.gitignore includes secrets/ and screenshots/",
        "Validates .wile/secrets/.env exists and has required keys",
        "Validates .wile/prd.json exists",
        "If all stories are passes=true, exits early with friendly message",
        "If .wile is not configured, exits with message to run bunx wile config",
        "--repo flag optional (can detect from current dir)",
        "--max-iterations flag optional (default 25)",
        "--test flag runs inside Docker with mocked agent, skipping GitHub/Claude",
        "In --test mode, skips .env required key validation",
        "In --test mode, mounts the current directory into the container and applies changes locally",
        "In --test mode, forwards .wile/secrets/.env and .wile/secrets/.env.project into the container for inspection",
        "In --test mode, sets WILE_TEST=true to trigger mocked agent behavior in the container",
        "In --test mode, entrypoint uses the mounted repo path instead of cloning from GitHub",
        "Forwards .wile/secrets/.env and .wile/secrets/.env.project into the container",
        "Shows how to monitor progress (git log, etc)"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Phase 1 - CLI."
    },
    {
      "id": "US-108A",
      "title": "Add run session logging to .wile/logs",
      "acceptanceCriteria": [
        "wile config ensures .wile/.gitignore includes logs/",
        "wile run creates .wile/logs/run-YYYYMMDD_HHMMSS.log before executing",
        "CLI run output is streamed to console and appended to the log file",
        "--test runs also write log files under .wile/logs",
        "Test verifies log file exists and includes mocked test mode output"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-108B",
      "title": "Publish CLI to npm for bunx usage",
      "acceptanceCriteria": [
        "CLI build produces dist/cli.js with executable shebang",
        "Package metadata is ready for npm publish (name, version, description)",
        "README includes setup, config, and run instructions",
        "npm publish succeeds under user account",
        "bunx wile works from a separate project repo"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-108B1",
      "title": "Adjust agent commit guidance to one commit per feature",
      "acceptanceCriteria": [
        "Prompt guidance updated to prefer a single commit per feature story",
        "Progress and PRD updates can be included in the same commit as the feature",
        "Acceptance criteria relaxed; will be verified manually"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-108C",
      "title": "Add local repo source mode (WILE_REPO_SOURCE)",
      "acceptanceCriteria": [
        "Introduce WILE_REPO_SOURCE env var with values: github or local",
        "wile config asks for repo source and writes WILE_REPO_SOURCE to .wile/secrets/.env",
        "When WILE_REPO_SOURCE=local, config skips prompts for GITHUB_TOKEN and GITHUB_REPO_URL",
        "Config validation only requires GitHub credentials when WILE_REPO_SOURCE=github",
        "wile run honors WILE_REPO_SOURCE unless overridden by explicit flags",
        "Local mode mounts the current directory into the container and skips git clone",
        "Local mode does not require GITHUB_TOKEN or GITHUB_REPO_URL",
        "Entrypoint supports local mode by using the mounted repo path and skipping GitHub auth",
        "CLI README documents local repo source behavior and requirements"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Phase 1 - CLI"
    },
    {
      "id": "US-108D",
      "title": "Add automated tests for CLI and agent flows",
      "acceptanceCriteria": [
        "Add test runner configuration for packages/cli (bun:test)",
        "Add integration test entrypoint scripts: scripts/test-local.sh and scripts/test-full.sh",
        "scripts/test-local.sh runs config flow tests and Docker test-mode run without GitHub/Claude",
        "scripts/test-full.sh runs everything in scripts/test-local.sh plus the real GitHub+Claude flow",
        "Test scripts use .wile/secrets/.env.test in this repo as the source of env vars",
        "Test scripts copy .env.test into temp repos under /tmp and always clean up via trap",
        "Config flow tests cover each conditional fork with prompts.inject (one test per branch path, no combinatorial matrix)",
        "Config flow tests verify .wile/secrets/.env and .wile/secrets/.env.project outputs",
        "Config flow tests are split across multiple files by feature area",
        "Integration test verifies Docker test mode creates .wile/logs run log",
        "Integration test verifies entrypoint --test path updates .wile/prd.json and .wile/progress.txt",
        "Integration test verifies env forwarding into container args via inspection or logging",
        "Full integration test uses the wile repo with branch name integration-test",
        "If integration-test exists, delete it before running the test",
        "Full integration test creates a new file with a haiku and then updates it in a second step",
        "Full integration test verifies the haiku file exists with both steps applied",
        "Full integration test deletes the integration-test branch on completion"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Phase 1 - CLI. STOP HERE. DO NOT CONTINUE WITHOUT HUMAN APPROVAL."
    },
    {
      "id": "US-109",
      "title": "Create EC2 launcher module",
      "acceptanceCriteria": [
        "src/lib/aws.ts exists",
        "Function to launch EC2 instance with params",
        "Uses r6a.xlarge instance type (32GB RAM)",
        "Uses Ubuntu 22.04 AMI",
        "Configures security group for outbound only",
        "Passes UserData script for bootstrap",
        "Tags instance with wile metadata",
        "Returns instance ID"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-110",
      "title": "Create UserData bootstrap script",
      "acceptanceCriteria": [
        "src/lib/userdata.ts generates bash script",
        "Installs Docker",
        "Pulls wile Docker image from registry",
        "Passes all env vars to container",
        "Runs container with appropriate flags",
        "Schedules self-termination on completion",
        "Logs to CloudWatch (optional)"
      ],
      "priority": 21,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-111",
      "title": "Create IAM policy documentation",
      "acceptanceCriteria": [
        "infra/iam-policy.json with minimal required permissions",
        "EC2: RunInstances, TerminateInstances, DescribeInstances",
        "EC2: CreateSecurityGroup, AuthorizeSecurityGroupEgress",
        "EC2: CreateTags",
        "Documentation on how to create IAM user",
        "Documentation on how to create fine-grained GitHub token"
      ],
      "priority": 22,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-112",
      "title": "Publish Docker image to registry",
      "acceptanceCriteria": [
        "Dockerfile builds successfully",
        "Image published to Docker Hub or ECR",
        "Image tagged with version",
        "UserData script references correct image",
        "Documentation on image updates"
      ],
      "priority": 23,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-113",
      "title": "Add 'wile status' command",
      "acceptanceCriteria": [
        "Lists running wile EC2 instances",
        "Shows instance ID, repo, branch, uptime",
        "Shows status (running, terminated)",
        "Can filter by repo"
      ],
      "priority": 24,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-114",
      "title": "Add 'wile stop' command",
      "acceptanceCriteria": [
        "Terminates a running wile instance by ID",
        "Confirms before terminating",
        "Shows success message"
      ],
      "priority": 25,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-115",
      "title": "Build and publish CLI to npm",
      "acceptanceCriteria": [
        "bun build produces dist/cli.js",
        "Package published to npm as 'wile'",
        "bunx wile config works",
        "bunx wile run works",
        "README with full usage instructions"
      ],
      "priority": 26,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    },
    {
      "id": "US-116",
      "title": "End-to-end test",
      "acceptanceCriteria": [
        "Create test repo with simple .wile/prd.json",
        "Run bunx wile run --repo=test",
        "Verify EC2 spawns",
        "Verify commits appear on branch",
        "Verify instance self-terminates",
        "Document any issues found"
      ],
      "priority": 27,
      "passes": false,
      "notes": "Phase 2 - EC2 (deferred)"
    }
  ]
}
